# 美工图表功能模块 - 完整文档

## 📋 功能概述

美工图表模块是招财猫系统的新增功能，用于管理美工需求的提交、分配、处理和完成流程。

### 核心功能
- 普通用户可以提交美工需求
- 美工部门用户可以查看需求，上传完成的图片/文件
- 所有用户可以预览和下载需求中的图片/文件
- 支持需求状态管理和进度跟踪

---

## 🗂️ 数据字段说明

### 按优先级排列

1. **时间** (createdAt)
   - 类型：Date
   - 说明：创建时间，自动生成
   - 必填：是（自动）

2. **需求** (requirement)
   - 类型：String
   - 说明：需求描述
   - 必填：是
   - 最大长度：1000字符

3. **部门** (department)
   - 类型：ObjectId (ref: Department)
   - 说明：提交需求的部门，自动关联当前用户部门
   - 必填：是（自动）

4. **图片** (images)
   - 类型：Array of ObjectId (ref: FileInfo)
   - 说明：美工上传的图片，支持预览
   - 必填：否
   - 限制：最多9张，单个文件不超过5MB

5. **分配美工** (assignedDesigner)
   - 类型：ObjectId (ref: User)
   - 说明：指派的美工用户
   - 必填：否

6. **预计完成时间** (expectedCompletionDate)
   - 类型：Date
   - 说明：预期交付日期
   - 必填：否

7. **贴图文件** (attachmentFiles)
   - 类型：Array of ObjectId (ref: FileInfo)
   - 说明：美工上传的文件，支持下载
   - 必填：否
   - 限制：单个文件不超过10MB

8. **已完成时间** (completedAt)
   - 类型：Date
   - 说明：实际完成时间，完成后自动记录
   - 必填：否（自动）

9. **备注** (remark)
   - 类型：String
   - 说明：补充说明
   - 必填：否
   - 最大长度：500字符

### 系统字段

- **状态** (status)
  - 类型：String
  - 枚举值：pending（待处理）、in_progress（进行中）、completed（已完成）
  - 默认值：pending

- **创建者** (createdBy)
  - 类型：ObjectId (ref: User)
  - 说明：创建需求的用户

- **更新者** (updatedBy)
  - 类型：ObjectId (ref: User)
  - 说明：最后更新需求的用户

---

## 🔌 API 接口

### 基础路径
```
/api/design-requests
```

### 接口列表

#### 1. 获取美工需求列表
```
GET /api/design-requests
```

**查询参数**:
- `page`: 页码（默认：1）
- `limit`: 每页数量（默认：10）
- `status`: 状态筛选（pending/in_progress/completed）
- `department`: 部门ID筛选
- `assignedDesigner`: 分配美工ID筛选
- `startDate`: 开始日期
- `endDate`: 结束日期
- `keyword`: 关键字搜索（需求描述或备注）

**响应**:
```json
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "pages": 10
  }
}
```

#### 2. 获取单个美工需求详情
```
GET /api/design-requests/:id
```

#### 3. 创建美工需求
```
POST /api/design-requests
```

**请求体**:
```json
{
  "requirement": "需求描述",
  "images": ["imageId1", "imageId2"],
  "remark": "备注信息"
}
```

#### 4. 更新美工需求
```
PUT /api/design-requests/:id
```

**请求体**:
```json
{
  "requirement": "更新的需求描述",
  "images": ["imageId1", "imageId2"],
  "assignedDesigner": "userId",
  "expectedCompletionDate": "2025-01-20",
  "attachmentFiles": ["fileId1", "fileId2"],
  "status": "in_progress",
  "remark": "更新的备注"
}
```

#### 5. 删除美工需求
```
DELETE /api/design-requests/:id
```

#### 6. 批量删除美工需求
```
DELETE /api/design-requests/batch
```

**请求体**:
```json
{
  "ids": ["id1", "id2", "id3"]
}
```

---

## 🎨 前端页面

### 路由配置
```
/design-charts/request-list
```

### 页面功能

#### 搜索区域
- 状态筛选（待处理/进行中/已完成）
- 关键字搜索（需求描述或备注）
- 搜索按钮
- 重置按钮

#### 操作按钮
- 新增需求
- 批量删除
- 刷新

#### 表格展示
| 列名 | 说明 |
|------|------|
| 时间 | 创建时间，支持排序 |
| 需求 | 需求描述，超长显示省略号 |
| 部门 | 提交部门名称 |
| 图片 | 图片数量标签 |
| 分配美工 | 美工用户名或"未分配" |
| 预计完成时间 | 日期格式 |
| 贴图文件 | 文件数量标签 |
| 已完成时间 | 日期格式 |
| 状态 | 状态标签（不同颜色） |
| 操作 | 查看、编辑、删除 |

#### 新增/编辑对话框
- 需求描述（必填，多行文本，最多1000字符）
- 图片上传（最多9张，支持预览和删除）
- 分配美工（下拉选择，可搜索）
- 预计完成时间（日期选择器）
- 贴图文件（文件上传）
- 状态（下拉选择）
- 备注（多行文本，最多500字符）

#### 查看详情对话框
- 完整信息展示
- 图片预览（点击放大）
- 文件下载链接

---

## 🔐 权限控制

### 查看权限
- 管理员：可以查看所有美工需求
- 普通用户：只能查看自己部门的美工需求

### 创建权限
- 所有用户都可以创建美工需求
- 前提：用户必须已分配部门

### 编辑权限
- 需求创建者可以编辑自己的需求
- 管理员可以编辑所有需求

### 删除权限
- 需求创建者可以删除自己的需求
- 管理员可以删除所有需求

---

## ✅ 验收标准

### 功能验收
- [x] 普通用户可以发布美工需求
- [x] 美工部门用户可以查看需求列表
- [x] 美工部门用户可以上传本地图片和文件到指定需求
- [x] 所有用户可以预览图片和下载文件
- [x] 支持需求状态管理（待处理、进行中、已完成）
- [x] 支持分配美工
- [x] 支持设置预计完成时间
- [x] 状态变更为"已完成"时自动记录完成时间
- [x] 支持批量删除
- [x] 完整的权限控制

### 技术验收
- [x] 后端使用 CommonJS 模块规范
- [x] 前端使用 Vue 3 Composition API
- [x] 错误处理使用中文字符串描述
- [x] 使用 asyncHandler 包装异步函数
- [x] 使用现有的文件上传机制
- [x] 页面布局与现有页面保持一致
- [x] 集成操作日志记录
- [x] 数据库索引优化

---

## 🧪 测试指南

### 后端测试
```bash
cd backend
node test-design-request.js
```

### 前端测试步骤

1. **创建美工需求**
   - 登录系统
   - 进入"美工图表" -> "需求列表"
   - 点击"新增需求"
   - 填写需求描述
   - 上传图片（可选）
   - 点击"确定"

2. **编辑美工需求**
   - 在列表中找到需求
   - 点击"编辑"
   - 修改信息（分配美工、上传文件等）
   - 点击"确定"

3. **查看美工需求**
   - 点击"查看"
   - 预览图片
   - 下载文件

4. **删除美工需求**
   - 点击"删除"
   - 确认删除

5. **批量删除**
   - 勾选多个需求
   - 点击"批量删除"
   - 确认删除

---

## 📝 注意事项

1. **图片上传限制**
   - 最多9张图片
   - 单个文件不超过5MB
   - 支持格式：JPG、PNG、GIF

2. **文件上传限制**
   - 单个文件不超过10MB
   - 支持常见文件格式

3. **部门要求**
   - 用户必须已分配部门才能提交美工需求
   - 需求自动关联用户的第一个部门

4. **权限限制**
   - 只有创建者或管理员可以编辑/删除需求
   - 普通用户只能查看自己部门的需求

5. **状态管理**
   - 状态变更为"已完成"时会自动记录完成时间
   - 完成时间不可手动修改

---

## 🔄 后续优化建议

1. **功能增强**
   - 添加需求评论功能
   - 添加需求优先级字段
   - 添加需求标签分类
   - 支持需求模板

2. **性能优化**
   - 图片压缩和缩略图
   - 分页加载优化
   - 缓存策略

3. **用户体验**
   - 拖拽上传图片
   - 图片批量上传
   - 进度条显示
   - 移动端适配优化

4. **通知提醒**
   - 新需求提交通知
   - 需求分配通知
   - 需求完成通知
   - 逾期提醒

---

## 📞 技术支持

如有问题，请查看：
- `must.md` - 开发规范
- `program.md` - 修改记录
- `backend/test-design-request.js` - 测试脚本

