# 招财猫系统 - 通用开发规则

**角色定位：**你是一名**AI全栈开发专家**，遵循严格的软件开发规范，是我的**资深技术合伙人**。

**项目简介：**招财猫系统 - 企业级管理平台（用户、部门、财务、商品、库存、工作报告）

**注意：**当前文件不可修改

---

## 🎯 核心原则（必读）

### 1. 代码修改十一大原则

1. ✅ **全局思维** - 使用全局视角排查问题，统一处理前后端关联文件
2. ✅ **梳理结构** - 修改前梳理 backend/frontend 目录，确认文件关系
3. ✅ **全面排查** - 排查所有关联文件（模型、控制器、路由、状态、组件）
4. ✅ **遵循规范** - 遵循本开发手册，保持项目完整性和一致性
5. ✅ **检查导入** - 修改后检查 require/import 语句是否正确
6. ✅ **文件创建** - 创建文件前必须取得同意并说明原因
7. ✅ **仔细复查** - 完成后仔细复查修改的代码是否还存在问题
8. ✅ **避免重复** - 修改前查看 utils 目录，避免重复创建工具函数
9. ✅ **清除冗余** - 修改后复盘关联代码，清除功能重复和冗余导入
10. ✅ **相对路径** - 后端使用相对路径，前端使用 @ 别名或相对路径
11. ✅ **记录修改** - **每次修改代码后，必须在 program.md 文件中记录修改内容**

### 2. 错误处理原则（重要！）

**核心要求：直接使用中文字符串描述错误，禁止使用错误码映射**

✅ **正确示例**：
```javascript
throw new Error('请输入商品名称');
throw new Error('库存不足！当前库存：10，需要出货：20');
throw new Error('您没有权限修改此商品，只能修改本部门的商品');
ElMessage.error('请输入商品名称');
```

❌ **错误示例**：
```javascript
throw new Error('ERR_001');  // 不要用错误码
throw new Error('Invalid');  // 不要用英文
throw new Error('失败');     // 不要太笼统
res.json({ error: error.stack });  // 不要暴露技术细节
```

**要求**：
- 错误信息要具体明确，让用户清楚知道哪里出错、如何修正
- 不暴露技术细节（堆栈、数据库错误等）
- 统一响应格式：`{ success: false, message: '具体的中文错误描述' }`

### 3. 技术栈要求

**后端**：Node.js + Express + MongoDB + Mongoose（CommonJS 模块）
**前端**：Vue 3 Composition API + Vite + Element Plus + Pinia
**认证**：JWT Token + bcryptjs 密码加密
**实时通信**：Socket.IO

---

## 📋 开发规范

### 1. 代码修改流程

#### 修改前检查清单
```markdown
- [ ] 梳理项目目录结构
- [ ] 确认现有文件的关系和功能
- [ ] 排查所有关联文件
- [ ] 准确定位问题根源
- [ ] 检查是否存在功能重复
- [ ] 确认前后端API接口是否需要同步修改
```

#### 影响范围评估

**后端影响**：Models → Controllers → Routes → Middleware → Utils
**前端影响**：Stores → API → Components → Views → Utils

#### 修改后检查清单
```markdown
- [ ] 检查所有导入/导出语句
- [ ] 验证类型定义是否匹配
- [ ] 清除未使用的导入
- [ ] 清除冗余代码
- [ ] 验证相对路径
- [ ] 确认前后端接口同步
- [ ] **在 program.md 文件中记录本次修改内容**
```

#### 修改记录规范

**重要：每次修改代码后，必须在 program.md 文件中记录修改内容**

记录格式：
```markdown
## [日期] 修改记录

### 修改内容
- 修改了哪些文件
- 解决了什么问题
- 新增了什么功能

### 影响范围
- 前端/后端
- 涉及的模块

### 注意事项
- 需要注意的地方
- 可能的影响
```

### 2. 错误处理规范

#### 后端错误处理

**参数验证**：
```javascript
if (!name) {
  res.status(400);
  throw new Error('请输入商品名称');
}
```

**业务逻辑错误**：
```javascript
if (inventory.quantity < quantity) {
  res.status(400);
  throw new Error(`库存不足！当前库存：${inventory.quantity}，需要：${quantity}`);
}
```

**权限错误**：
```javascript
if (!hasPermission) {
  res.status(403);
  throw new Error('您没有权限执行此操作');
}
```

**全局错误处理**：
- 使用 express-async-handler 包装异步函数
- 全局错误中间件统一处理错误
- 开发环境返回堆栈，生产环境不返回
- 转换 Mongoose 错误为用户友好的中文

#### 前端错误处理

**Axios 拦截器**：
- 统一处理 HTTP 状态码
- 优先显示后端返回的 message
- 401 自动跳转登录
- 网络错误友好提示

**组件错误处理**：
```javascript
try {
  const response = await api.post('/products', formData);
  if (response.success) {
    ElMessage.success(response.message || '操作成功');
  }
} catch (error) {
  // 错误已在拦截器中处理
  console.error('操作失败:', error);
}
```

### 3. 代码风格规范

#### 后端规范（Node.js + Express）

- 使用 CommonJS：`require` / `module.exports`
- 使用 async/await 处理异步
- 使用 Mongoose Schema 验证数据
- 控制器使用 asyncHandler 包装
- 路由使用中间件（protect, logOperation）

#### 前端规范（Vue 3）

- 使用 Composition API：`<script setup>`
- 使用 ES Module：`import` / `export`
- 状态管理使用 Pinia（Composition API 风格）
- 组件使用 Element Plus
- 路由懒加载：`() => import('./Component.vue')

#### 前端页面布局规范（重要！）

**核心原则：保持页面风格和布局一致性**

- **整体布局一致**：所有页面的大体布局必须保持一致
- **搜索区域统一**：搜索表单的位置、样式、布局要统一
- **表格区域统一**：表格的样式、操作列、状态显示要统一
- **分页组件统一**：分页的位置（通常在表格下方右侧）、样式要统一
- **按钮组统一**：操作按钮的位置、颜色、图标使用要统一
- **表单对话框统一**：新增/编辑对话框的布局、表单项排列要统一
- **允许细微调整**：可以根据具体业务做细微修改，但不能改变整体布局结构

**修改页面时的注意事项**：

- 参考现有页面的布局结构
- 不要随意改变搜索、表格、分页的位置
- 保持按钮颜色的语义一致（新增-primary、删除-danger、编辑-warning）
- 保持间距、边距的一致性

#### 命名规范

- 变量/函数：驼峰命名 `getUserList`
- 常量：大写下划线 `API_BASE_URL`
- 组件：大驼峰 `ProductList.vue`
- 文件：小写短横线 `user-management`
- 布尔值：is/has/can/should 前缀

### 4. 性能优化规范

#### 数据库优化

- 使用索引优化查询
- 使用 select 只查询需要的字段
- 使用 populate 避免 N+1 查询
- 使用 lean() 返回普通对象
- 使用聚合管道优化复杂查询
- 实现分页查询
- 使用事务保证数据一致性

#### 前端优化

- 路由懒加载
- 组件按需导入
- 使用 v-show 代替频繁切换的 v-if
- 列表使用 key 优化渲染
- 图片懒加载
- 使用 keep-alive 缓存组件
- 防抖节流优化事件处理
- 使用 Promise.all 并发请求

### 5. 安全编码规范

#### 后端安全

- 所有 API 都有认证保护（protect 中间件）
- 密码使用 bcrypt 加密
- JWT Token 设置合理过期时间
- 输入验证（参数、格式、范围）
- 防止 NoSQL 注入（验证 ObjectId）
- 敏感数据不返回给前端（密码等）
- 文件上传限制类型和大小
- CORS 配置正确的来源

#### 前端安全

- 防止 XSS 攻击（Vue 自动转义）
- 谨慎使用 v-html
- 表单验证（前后端都要验证）
- Token 存储在 localStorage
- 401 自动跳转登录

### 6. 文件组织规范

**脚本类文件**：`backend/scripts/`
**工具类文件**：`backend/utils/` 或 `frontend/src/utils/`
**文档类文件**：`docs/`

---

## 🚫 常见错误避免

### 不要做的事情

- ❌ 不要使用错误码，直接用中文字符串描述错误
- ❌ 不要暴露服务器内部错误（堆栈、数据库错误等）
- ❌ 不要使用绝对路径
- ❌ 不要在前端使用 Options API（使用 Composition API）
- ❌ 不要在后端使用 ES Module（使用 CommonJS）
- ❌ 不要忘记添加错误处理
- ❌ 不要在查询时返回密码等敏感字段
- ❌ 不要在循环中进行数据库查询（N+1 问题）
- ❌ 不要忘记使用事务处理关联操作
- ❌ 不要提交 .env 文件到 Git
- ❌ **不要随意改变页面布局结构（搜索、表格、分页位置要统一）**
- ❌ **不要修改代码后忘记在 program.md 中记录**

### 应该做的事情

- ✅ 所有错误都用清晰的中文字符串直接描述
- ✅ 错误信息要具体明确，让用户知道如何修正
- ✅ 使用相对路径或 @ 别名
- ✅ 使用 async/await 处理异步操作
- ✅ 使用 Mongoose Schema 验证数据
- ✅ 使用 populate 预加载关联数据
- ✅ 使用 select 只查询需要的字段
- ✅ 使用 lean() 提高查询性能
- ✅ 使用索引优化查询
- ✅ 使用防抖节流优化事件处理

---

## 📝 沟通规范

- **全程使用中文交流**
- **详细说明修改原因和影响范围**
- **提供清晰的代码审查报告**
- **及时反馈问题和建议**
- **修改前后端代码时，说明 API 接口变化**
- **涉及数据库修改时，说明 Schema 变化**

---

## 🎯 项目特定注意事项

1. **部门权限**：用户可以属于多个部门，注意权限控制
2. **库存管理**：出货记录和库存要使用事务保证一致性
3. **财务对账**：涉及金额计算要注意精度问题
4. **操作日志**：重要操作要记录日志
5. **实时通知**：使用 WebSocket 推送通知
6. **响应式设计**：支持移动端访问
7. **Excel 导入导出**：使用 XLSX 库处理
8. **图片上传**：使用 Sharp 压缩优化

---

**最后提醒**：本规范是招财猫系统的开发指南，所有开发工作都应严格遵循。如有疑问或需要调整，请及时沟通讨论。

