# 收支记录图片功能测试指南

## 功能概述

为收支记录添加了图片上传、预览和删除功能，用户可以在新增或编辑收支记录时上传相关图片作为凭证。

**重要说明**：图片只有在用户点击"确认"按钮提交表单时才会真正保存到后端数据库中。在此之前，图片只是临时存储在前端，用户可以随时添加或删除。

## 已实现的功能

### 1. 后端功能
- ✅ 修改 Finance 模型，添加 `images` 字段用于存储关联的图片文件ID列表
- ✅ 更新财务记录的创建和更新接口，支持处理图片字段
- ✅ 在所有相关查询中添加图片信息的 populate

### 2. 前端功能
- ✅ 在收支记录表单中添加图片上传组件
- ✅ 支持多图片上传（最多9张）
- ✅ 图片预览功能（点击可查看大图）
- ✅ 图片删除功能
- ✅ 在表格中显示图片数量指示器
- ✅ 添加文件上传相关的API接口

### 3. 技术特性
- 支持的图片格式：JPG、PNG、GIF、BMP、WebP、SVG
- 单个文件大小限制：10MB
- 最大图片数量：9张
- 图片存储：使用 GridFS 存储在 MongoDB 中
- 图片预览：支持点击预览大图
- **延迟上传**：图片在表单提交时才真正上传到服务器
- **临时预览**：选择图片后立即显示本地预览

## 测试步骤

### 1. 启动服务
```bash
# 启动后端服务
cd backend
npm start

# 启动前端服务
cd frontend
npm run dev
```

### 2. 登录系统
- 访问 http://localhost:5174
- 使用有效的用户账号登录

### 3. 测试图片上传功能

#### 3.1 新增收支记录时上传图片
1. 进入财务管理 -> 收支记录页面
2. 点击"新增收支记录"按钮
3. 填写必要的表单信息（团队账户、记录名称、类型、金额等）
4. 在"相关图片"区域点击"选择图片"按钮
5. 选择一张或多张图片文件（注意格式和大小限制）
6. 验证图片是否正确显示在预览区域（此时图片只是临时预览）
7. 可以继续添加更多图片或删除已选择的图片
8. 点击"确定"保存记录（此时图片才真正上传到服务器）
9. 检查表格中是否显示图片数量指示器

#### 3.2 编辑收支记录时管理图片
1. 在收支记录列表中点击某条记录的"编辑"按钮
2. 在编辑对话框中查看已有图片
3. 测试添加新图片
4. 测试删除已有图片（点击图片上的删除按钮）
5. 保存修改并验证结果

#### 3.3 图片预览功能
1. 在有图片的收支记录编辑界面
2. 点击任意一张图片
3. 验证是否能正确打开图片预览
4. 测试预览界面的左右切换功能

### 4. 测试边界情况

#### 4.1 文件格式限制
- 尝试上传不支持的文件格式（如 .txt、.doc 等）
- 验证是否显示正确的错误提示

#### 4.2 文件大小限制
- 尝试上传超过10MB的图片
- 验证是否显示正确的错误提示

#### 4.3 数量限制
- 尝试上传超过9张图片
- 验证是否显示正确的错误提示

#### 4.4 网络异常
- 在上传过程中断网
- 验证错误处理是否正常

### 5. 验证数据持久化
1. 上传图片并保存记录
2. 刷新页面或重新登录
3. 验证图片是否仍然存在
4. 验证图片预览是否正常

## 预期结果

### 成功场景
- 图片能够正常上传并显示预览
- 表格中正确显示图片数量指示器
- 图片预览功能正常工作
- 图片删除功能正常工作
- 数据能够正确保存和加载

### 错误处理
- 不支持的文件格式会显示错误提示
- 超大文件会显示错误提示
- 超过数量限制会显示错误提示
- 网络错误会显示相应提示

## 注意事项

1. 确保后端服务正常运行且 MongoDB 连接正常
2. 确保用户有相应的权限（finance:create、finance:update 等）
3. 图片文件存储在 MongoDB GridFS 中，删除记录时相关图片也会被删除
4. **重要**：图片只有在点击"确认"按钮提交表单时才会真正上传到服务器
5. 如果用户取消操作或关闭对话框，临时选择的图片不会保存到服务器
6. 编辑记录时删除图片，只有在提交表单后图片文件才会从服务器删除

## 故障排除

### 常见问题
1. **上传失败**：检查网络连接、文件格式、文件大小
2. **预览失败**：检查图片文件是否损坏、服务器是否正常
3. **权限错误**：检查用户是否有相应的操作权限
4. **样式问题**：检查 CSS 是否正确加载

### 调试方法
1. 打开浏览器开发者工具查看网络请求
2. 检查控制台是否有错误信息
3. 查看后端服务器日志
4. 检查 MongoDB 中的数据是否正确保存
