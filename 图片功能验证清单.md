# 收支记录图片功能验证清单

## 修改后的工作流程

### ✅ 新的图片处理逻辑
1. **选择图片阶段**：
   - 用户点击"选择图片"按钮
   - 选择图片文件后立即显示本地预览
   - 图片此时只存储在前端内存中，未上传到服务器
   - 可以继续添加或删除图片

2. **提交表单阶段**：
   - 用户点击"确认"按钮
   - 系统先上传所有新选择的图片到服务器
   - 获取图片文件ID后，将ID包含在财务记录中保存
   - 删除标记为删除的已保存图片文件

3. **取消操作**：
   - 如果用户取消或关闭对话框
   - 临时选择的图片不会保存到服务器
   - 释放本地预览的内存资源

## 快速验证步骤

### 1. 新增记录测试
```
□ 打开新增收支记录对话框
□ 点击"选择图片"，选择1-2张图片
□ 验证图片立即显示预览
□ 填写其他必要信息
□ 点击"确认"提交
□ 验证记录保存成功且表格显示图片数量
□ 编辑该记录，验证图片正确加载
```

### 2. 取消操作测试
```
□ 打开新增收支记录对话框
□ 选择几张图片
□ 点击"取消"或关闭对话框
□ 重新打开对话框，验证图片列表为空
□ 检查服务器，确认没有产生垃圾文件
```

### 3. 编辑记录测试
```
□ 编辑一个已有图片的记录
□ 验证现有图片正确显示
□ 添加新图片
□ 删除一张现有图片
□ 提交保存
□ 验证新图片已保存，删除的图片已移除
```

### 4. 错误处理测试
```
□ 尝试上传超大文件（>10MB）
□ 尝试上传不支持的格式
□ 尝试上传超过9张图片
□ 在网络断开时提交表单
□ 验证所有错误都有适当提示
```

## 技术验证点

### 前端验证
- [ ] 图片预览使用 `URL.createObjectURL()` 创建本地URL
- [ ] 表单重置时正确调用 `URL.revokeObjectURL()` 释放内存
- [ ] 提交时正确区分新图片（File对象）和已保存图片（对象）
- [ ] 删除图片时正确标记已保存图片ID到删除列表

### 后端验证
- [ ] 图片只在表单提交时才保存到GridFS
- [ ] 财务记录正确关联图片文件ID
- [ ] 删除的图片文件从GridFS中正确移除
- [ ] 数据库中的images字段正确更新

### 数据一致性验证
- [ ] 刷新页面后图片仍然正确显示
- [ ] 编辑记录时图片数据正确加载
- [ ] 删除财务记录时关联图片也被删除
- [ ] 没有产生孤立的图片文件

## 性能验证

### 内存管理
- [ ] 大量选择和删除图片不会导致内存泄漏
- [ ] 关闭对话框时正确释放所有临时资源
- [ ] 长时间使用不会出现性能下降

### 网络优化
- [ ] 只有在提交时才进行网络上传
- [ ] 批量上传图片的效率
- [ ] 上传失败时的重试机制

## 用户体验验证

### 界面响应
- [ ] 图片选择后立即显示预览
- [ ] 上传过程中显示适当的加载状态
- [ ] 错误提示清晰明确
- [ ] 操作流程符合用户直觉

### 边界情况
- [ ] 网络慢时的用户体验
- [ ] 大文件上传时的响应
- [ ] 同时操作多个对话框的情况

## 预期改进效果

### ✅ 解决的问题
1. **避免垃圾文件**：取消操作不会在服务器产生无用文件
2. **提高性能**：减少不必要的网络请求
3. **改善体验**：用户可以自由调整图片选择，最后一次性提交
4. **数据一致性**：图片和记录数据同时保存，避免不一致状态

### ✅ 保持的优势
1. **即时预览**：选择图片后立即可以预览
2. **批量操作**：支持一次选择多张图片
3. **错误处理**：完善的文件格式和大小验证
4. **权限控制**：基于用户权限的操作限制

## 测试完成标准

当以上所有验证点都通过时，图片功能可以认为已经正确实现了延迟上传的逻辑。

## 注意事项

1. 测试时注意观察浏览器开发者工具的网络面板，确认图片只在提交时上传
2. 检查浏览器内存使用情况，确认没有内存泄漏
3. 测试不同浏览器的兼容性
4. 验证移动端的使用体验
